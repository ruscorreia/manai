#!/usr/bin/env python3

import argparse
import json
import os
import sys
import requests
import getpass
from typing import Optional, Dict, Any
from datetime import datetime

class ManaiFreemiumAzureClient:
    """Cliente para interagir com o ManAI Freemium atrav√©s das Azure Functions em produ√ß√£o."""
    
    def __init__(self, base_url: str = "https://manai-agent-function-app.azurewebsites.net/api", 
                 function_key: str = "58H0KD8feP9x2e6uqY1wkwW-6MqwrNkWI6U4-jdsSa5EAzFuACdqNA=="):
        """
        Inicializa o cliente ManAI Freemium para Azure.
        
        Args:
            base_url: URL base das Azure Functions em produ√ß√£o
            function_key: Chave de acesso √†s Azure Functions
        """
        self.base_url = base_url.rstrip('/')
        self.function_key = function_key
        self.config_dir = os.path.expanduser("~/.config/manai")
        self.config_file = os.path.join(self.config_dir, "config.json")
        self.session_file = os.path.join(self.config_dir, "session.json")
        
        # Criar direct√≥rio de configura√ß√£o se n√£o existir
        os.makedirs(self.config_dir, exist_ok=True)
        
        # Carregar configura√ß√£o
        self.config = self._load_config()
        
    def _load_config(self) -> Dict[str, Any]:
        """Carrega a configura√ß√£o do utilizador."""
        try:
            if os.path.exists(self.config_file):
                with open(self.config_file, 'r') as f:
                    return json.load(f)
        except (json.JSONDecodeError, IOError):
            pass
        return {}
    
    def _save_config(self):
        """Guarda a configura√ß√£o do utilizador."""
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self.config, f, indent=2)
        except IOError as e:
            print(f"‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel guardar configura√ß√£o: {e}")
    
    def _load_session(self) -> Optional[Dict[str, Any]]:
        """Carrega informa√ß√µes da sess√£o anterior."""
        try:
            if os.path.exists(self.session_file):
                with open(self.session_file, 'r') as f:
                    return json.load(f)
        except (json.JSONDecodeError, IOError):
            pass
        return None
    
    def _save_session(self, session_data: Dict[str, Any]):
        """Guarda informa√ß√µes da sess√£o."""
        print(f"üîí Guardando sess√£o...{session_data}")
        try:
            with open(self.session_file, 'w') as f:
                json.dump(session_data, f, indent=2)
        except IOError as e:
            print(f"‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel guardar sess√£o: {e}")
    
    def _get_headers(self, include_auth: bool = True, include_function_key: bool = True) -> Dict[str, str]:
        """Retorna os cabe√ßalhos HTTP necess√°rios."""
        headers = {
            "Content-Type": "application/json",
            "User-Agent": "manai-freemium-azure-cli/2.0"
        }
        
        # Adicionar chave da fun√ß√£o Azure
        if include_function_key and self.function_key:
            headers["x-functions-key"] = self.function_key
        
        # Adicionar token JWT se dispon√≠vel
        if include_auth and self.config.get('token'):
            headers["Authorization"] = f"Bearer {self.config['token']}"
            
        return headers
    
    def _make_request(self, endpoint: str, method: str = "GET", data: Optional[Dict] = None, 
                     include_auth: bool = True, include_function_key: bool = True) -> Dict[str, Any]:
        """Faz uma requisi√ß√£o HTTP para a API Azure."""
        url = f"{self.base_url}/{endpoint}"
        headers = self._get_headers(include_auth, include_function_key)
        
        try:
            if method.upper() == "GET":
                response = requests.get(url, headers=headers, timeout=120)  # Timeout maior para Azure
            elif method.upper() == "POST":
                response = requests.post(url, headers=headers, json=data, timeout=120)
            elif method.upper() == "PUT":
                response = requests.put(url, headers=headers, json=data, timeout=120)
            else:
                return {"success": False, "error": f"M√©todo HTTP n√£o suportado: {method}"}
            
            # Verificar status codes espec√≠ficos
            if response.status_code == 401:
                return {"success": False, "error": "Token inv√°lido ou expirado. Execute 'manai login'"}
            elif response.status_code == 403:
                return {"success": False, "error": "Acesso negado. Verifique a chave da fun√ß√£o Azure"}
            elif response.status_code == 404:
                return {"success": False, "error": f"Endpoint n√£o encontrado: {endpoint}"}
            elif response.status_code == 429:
                return {"success": False, "error": "Limite de consultas atingido. Considere fazer upgrade para ManAI Pro"}
            elif response.status_code == 500:
                return {"success": False, "error": "Erro interno do servidor Azure. Tente novamente mais tarde"}
            
            response.raise_for_status()
            
            # Tentar fazer parse do JSON
            try:
                return response.json()
            except json.JSONDecodeError:
                # Se n√£o for JSON v√°lido, retornar texto como resposta
                return {"success": True, "message": response.text}
            
        except requests.exceptions.Timeout:
            return {"success": False, "error": "Timeout na comunica√ß√£o com Azure. Tente novamente"}
        except requests.exceptions.ConnectionError:
            return {"success": False, "error": "Erro de conex√£o com Azure. Verifique sua internet"}
        except requests.exceptions.RequestException as e:
            return {"success": False, "error": f"Erro de comunica√ß√£o: {str(e)}"}
    
    def register(self, email: str, password: str, first_name: str, last_name: str, 
                language: str = "pt") -> Dict[str, Any]:
        """Regista um novo utilizador."""
        data = {
            "Email": email,
            "Password": password,
            "FirstName": first_name,
            "FastName": last_name,
            "PreferredLanguage": language
        }
        
        result = self._make_request("RegisterUser", "POST", data, include_auth=False)
        
        if result.get("success"):
            # Guardar token e informa√ß√µes do utilizador
            self.config["token"] = result["token"]
            self.config["user"] = result["user"]
            self._save_config()
            
        return result
    
    def login(self, email: str, password: str) -> Dict[str, Any]:
        """Faz login do utilizador."""
        data = {
            "Email": email,
            "Password": password
        }
        
        result = self._make_request("LoginUser", "POST", data, include_auth=False)
        
        if result.get("success"):
            # Guardar token e informa√ß√µes do utilizador
            self.config["token"] = result["token"]
            self.config["user"] = result["user"]
            self._save_config()
            
        return result
    
    def logout(self):
        """Faz logout do utilizador."""
        self.config.pop("token", None)
        self.config.pop("user", None)
        self._save_config()
        
        # Limpar sess√£o
        if os.path.exists(self.session_file):
            os.remove(self.session_file)
    
    def get_profile(self) -> Dict[str, Any]:
        """Obt√©m o perfil do utilizador."""
        return self._make_request("GetUserProfile", "GET")
    
    def get_tier_config(self) -> Dict[str, Any]:
        """Obt√©m a configura√ß√£o do tier actual."""
        return self._make_request("GetTierConfiguration", "GET")
    
    def check_usage_limits(self, language: str = "pt") -> Dict[str, Any]:
        """Verifica os limites de utiliza√ß√£o."""
        data = {"Language": language}
        return self._make_request("CheckUsageLimit", "POST", data)
    
    def get_usage_stats(self) -> Dict[str, Any]:
        """Obt√©m estat√≠sticas de utiliza√ß√£o."""
        return self._make_request("GetUsageStatistics", "GET")
    
    def check_feature_access(self, feature_name: str) -> Dict[str, Any]:
        """Verifica acesso a uma funcionalidade espec√≠fica."""
        data = {"featureName": feature_name}
        return self._make_request("CheckFeatureAccess", "POST", data)
    
    def ask_question(self, question: str, language: str = "pt", use_session: bool = True) -> Dict[str, Any]:
        """
        Envia uma pergunta para o agente ManAI.
        
        Args:
            question: A pergunta a fazer ao agente
            language: Idioma da resposta
            use_session: Se deve usar a sess√£o anterior para contexto
            
        Returns:
            Dicion√°rio com a resposta do agente
        """
        # Verificar se est√° autenticado
        if not self.config.get('token'):
            return {"success": False, "error": "√â necess√°rio fazer login primeiro. Execute 'manai login'"}
        
        # Preparar o payload
        payload = {
            "Question": question,
            "Language": language
        }
        
        # Carregar thread ID se usar sess√£o
        if use_session:
            session = self._load_session()
            if session and session.get('ThreadId'):
                payload["ThreadId"] = session['ThreadId']
        
        # Tentar primeiro a fun√ß√£o freemium (se dispon√≠vel)
        result = self._make_request("ManaiAgentFreemiumHttpTrigger", "POST", payload)
        
        # Guardar informa√ß√µes da sess√£o se bem-sucedido
        if result.get('success') and use_session:
            thread_id = result.get('ThreadId') or result.get('threadId')
            session_id = result.get('SessionId') or result.get('sessionId')
            
            if thread_id:
                session_data = {
                    'ThreadId': thread_id,
                    'SessionId': session_id,
                    'lastUsed': datetime.now().isoformat()
                }
                self._save_session(session_data)
        
        return result
    
    def is_authenticated(self) -> bool:
        """Verifica se o utilizador est√° autenticado."""
        if not self.config.get('token'):
            return False
        
        # Tentar validar token (se fun√ß√£o dispon√≠vel)
        result = self._make_request("ValidateToken", "POST")
        if result.get('valid') is not None:
            return result.get('valid', False)
        
        # Se fun√ß√£o de valida√ß√£o n√£o dispon√≠vel, assumir que token existe = autenticado
        return True
    
    def test_connection(self) -> Dict[str, Any]:
        """Testa a conex√£o com as Azure Functions."""
        try:
            # Testar fun√ß√£o original primeiro
            result = self._make_request("ManaiAgentHttpTrigger", "GET", include_auth=False)
            
            if result.get('success') or "m√©todo n√£o permitido" in result.get('error', '').lower():
                return {
                    "success": True, 
                    "message": "Conex√£o com Azure Functions estabelecida",
                    "functions_available": ["ManaiAgentHttpTrigger"]
                }
            else:
                return {
                    "success": False,
                    "error": f"Falha na conex√£o: {result.get('error')}"
                }
        except Exception as e:
            return {
                "success": False,
                "error": f"Erro ao testar conex√£o: {str(e)}"
            }

def print_welcome():
    """Imprime mensagem de boas-vindas."""
    print("ü§ñ ManAI Freemium Azure - O seu assistente de comandos Linux com IA")
    print("üåê Conectado √†s Azure Functions em produ√ß√£o")
    print("=" * 65)

def print_tier_info(client: ManaiFreemiumAzureClient):
    """Mostra informa√ß√µes sobre o tier actual."""
    if not client.is_authenticated():
        print("‚ùå N√£o autenticado. Execute 'manai login' primeiro.")
        return
    
    # Tentar obter informa√ß√µes do perfil freemium
    profile = client.get_profile()
    tier_config = client.get_tier_config()
    usage_stats = client.get_usage_stats()
    
    # Se fun√ß√µes freemium n√£o dispon√≠veis, mostrar informa√ß√£o b√°sica
    if not profile.get('success', True) and "n√£o encontrado" in profile.get('error', '').lower():
        print("‚ÑπÔ∏è  Usando fun√ß√£o Azure original (sem sistema freemium)")
        print(f"üë§ Utilizador: {client.config.get('user', {}).get('email', 'N/A')}")
        print("üéØ Tier: ORIGINAL (sem limita√ß√µes)")
        print("üìä Consultas: Ilimitadas")
        print("üåç Idiomas: Todos suportados")
        return
    
    if not profile.get('success', True):
        print(f"‚ùå Erro ao obter perfil: {profile.get('error')}")
        return
    
    if not tier_config.get('success', True):
        print(f"‚ùå Erro ao obter configura√ß√£o: {tier_config.get('error')}")
        return
    
    print(f"\nüë§ Utilizador: {client.config.get('user', {}).get('email', 'N/A')}")
    print(f"üéØ Tier: {tier_config.get('tierType', 'N/A').upper()}")
    
    if tier_config.get('dailyQueryLimit', 0) > 0:
        today_usage = 0
        if usage_stats.get('success', True) and usage_stats.get('dailyStatistics'):
            # Data de hoje
            today_str = datetime.now().date()

            # Buscar estat√≠sticas de hoje
            today_stats = next(
                (s for s in usage_stats['dailyStatistics']
                if datetime.fromisoformat(s['date']).date() == today_str),
                None
            )
            if today_stats:
                today_usage = today_stats['queriesCount']
        
        print(f"üìä Utiliza√ß√£o hoje: {today_usage}/{tier_config['dailyQueryLimit']}")
    else:
        print("üìä Consultas: Ilimitadas")
    
    print(f"üåç Idiomas: {', '.join(tier_config.get('supportedLanguages', []))}")
    
    features = tier_config.get('features', {})
    print(f"‚ú® Funcionalidades:")
    print(f"   ‚Ä¢ Mem√≥ria longo prazo: {'‚úÖ' if features.get('longTermMemory') else '‚ùå'}")
    print(f"   ‚Ä¢ Comandos personalizados: {'‚úÖ' if features.get('customCommands') else '‚ùå'}")
    print(f"   ‚Ä¢ Integra√ß√£o IDEs: {'‚úÖ' if features.get('ideIntegration') else '‚ùå'}")
    print(f"   ‚Ä¢ Analytics: {'‚úÖ' if features.get('analytics') else '‚ùå'}")

def interactive_register(client: ManaiFreemiumAzureClient):
    """Processo interactivo de registo."""
    print("\nüìù Registo de novo utilizador")
    print("-" * 30)
    
    email = input("Email: ").strip()
    if not email:
        print("‚ùå Email √© obrigat√≥rio")
        return False
    
    password = getpass.getpass("Password: ")
    if len(password) < 8:
        print("‚ùå Password deve ter pelo menos 8 caracteres")
        return False
    
    first_name = input("Primeiro nome: ").strip()
    last_name = input("√öltimo nome: ").strip()
    
    print("\nIdiomas dispon√≠veis: pt (portugu√™s), en (ingl√™s), es (espanhol)")
    language = input("Idioma preferido [pt]: ").strip() or "pt"
    
    print("\n‚è≥ A registar utilizador no Azure...")
    result = client.register(email, password, first_name, last_name, language)
    
    if result.get("success"):
        print("‚úÖ Registo bem-sucedido!")
        print(f"üéØ Tier inicial: {result['user']['tierType'].upper()}")
        return True
    else:
        error_msg = result.get('error', '')
        if "n√£o encontrado" in error_msg.lower():
            print("‚ö†Ô∏è  Fun√ß√£o de registo n√£o dispon√≠vel na vers√£o actual do Azure")
            print("üí° Contacte o administrador para criar conta manualmente")
        else:
            print(f"‚ùå Erro no registo: {error_msg}")
        return False

def interactive_login(client: ManaiFreemiumAzureClient):
    """Processo interactivo de login."""
    print("\nüîê Login")
    print("-" * 10)
    
    email = input("Email: ").strip()
    if not email:
        print("‚ùå Email √© obrigat√≥rio")
        return False
    
    password = getpass.getpass("Password: ")
    
    print("\n‚è≥ A fazer login no Azure...")
    result = client.login(email, password)
    
    if result.get("success"):
        print("‚úÖ Login bem-sucedido!")
        print(f"üë§ Bem-vindo, {result['user']['firstName']}!")
        print(f"üéØ Tier: {result['user']['tierType'].upper()}")
        return True
    else:
        error_msg = result.get('error', '')
        print(f"‚ùå Erro no login: {error_msg}")
        return False

def main():
    parser = argparse.ArgumentParser(
        description="ManAI Freemium Azure - O seu assistente de comandos Linux com IA",
        epilog="Exemplos:\n"
               "  manai 'como listar ficheiros ocultos?'\n"
               "  manai 'criar um direct√≥rio com permiss√µes espec√≠ficas'\n"
               "  manai --new-session 'como usar o comando find?'\n"
               "  manai --register\n"
               "  manai --login\n"
               "  manai --status\n"
               "  manai --test-connection",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument(
        "query",
        type=str,
        nargs='?',
        help="A sua pergunta em linguagem natural sobre comandos Linux"
    )
    
    parser.add_argument(
        "--new-session",
        action="store_true",
        help="Iniciar uma nova sess√£o (ignorar contexto anterior)"
    )
    
    parser.add_argument(
        "--language", "-l",
        type=str,
        default="pt",
        choices=["pt", "en", "es", "fr", "de", "it", "ja", "zh", "ru", "ar"],
        help="Idioma da resposta (padr√£o: pt)"
    )
    
    parser.add_argument(
        "--register",
        action="store_true",
        help="Registar novo utilizador"
    )
    
    parser.add_argument(
        "--login",
        action="store_true",
        help="Fazer login"
    )
    
    parser.add_argument(
        "--logout",
        action="store_true",
        help="Fazer logout"
    )
    
    parser.add_argument(
        "--status",
        action="store_true",
        help="Mostrar estado actual e informa√ß√µes do tier"
    )
    
    parser.add_argument(
        "--stats",
        action="store_true",
        help="Mostrar estat√≠sticas de utiliza√ß√£o"
    )
    
    parser.add_argument(
        "--check-feature",
        type=str,
        help="Verificar acesso a uma funcionalidade espec√≠fica"
    )
    
    parser.add_argument(
        "--test-connection",
        action="store_true",
        help="Testar conex√£o com Azure Functions"
    )
    
    parser.add_argument(
        "--url",
        type=str,
        default="https://manai-agent-function-app.azurewebsites.net/api",
        help="URL base da API Azure (padr√£o: https://manai-agent-function-app.azurewebsites.net/api)"
    )
    
    parser.add_argument(
        "--function-key",
        type=str,
        default="58H0KD8feP9x2e6uqY1wkwW-6MqwrNkWI6U4-jdsSa5EAzFuACdqNA==",
        help="Chave de acesso √†s Azure Functions"
    )
    
    parser.add_argument(
        "--version",
        action="version",
        version="manai-freemium-azure 2.0.0 - Modelo Freemium com Azure Functions"
    )

    args = parser.parse_args()
    
    # Criar cliente Azure
    client = ManaiFreemiumAzureClient(args.url, args.function_key)
    
    # Testar conex√£o se solicitado
    if args.test_connection:
        print("üîç Testando conex√£o com Azure Functions...")
        result = client.test_connection()
        if result.get('success'):
            print(f"‚úÖ {result.get('message')}")
            if result.get('functions_available'):
                print(f"üìã Fun√ß√µes dispon√≠veis: {', '.join(result['functions_available'])}")
        else:
            print(f"‚ùå {result.get('error')}")
        return
    
    # Mostrar boas-vindas se nenhum comando espec√≠fico
    if not any([args.register, args.login, args.logout, args.status, args.stats, args.check_feature, args.query]):
        print_welcome()
        parser.print_help()
        return
    
    # Processar comandos de gest√£o de conta
    if args.register:
        interactive_register(client)
        return
    
    if args.login:
        interactive_login(client)
        return
    
    if args.logout:
        client.logout()
        print("‚úÖ Logout realizado com sucesso")
        return
    
    if args.status:
        print_tier_info(client)
        return
    
    if args.stats:
        if not client.is_authenticated():
            print("‚ùå √â necess√°rio fazer login primeiro")
            return
        
        stats = client.get_usage_stats()
        if stats.get('success', True):
            print(f"\nüìä Estat√≠sticas de Utiliza√ß√£o")
            print("-" * 30)
            print(f"Total de consultas: {stats.get('totalQueries', 0)}")
            print(f"M√©dia por dia: {stats.get('averageQueriesPerDay', 0):.1f}")
            print(f"Tier actual: {stats.get('currentTier', 'N/A').upper()}")
            
            if stats.get('dailyStatistics'):
                print("\n√öltimos 7 dias:")
                for stat in stats['dailyStatistics'][:7]:
                    date = datetime.fromisoformat(stat['date']).strftime('%d/%m')
                    print(f"  {date}: {stat['queriesCount']} consultas")
        else:
            if "n√£o encontrado" in stats.get('error', '').lower():
                print("‚ÑπÔ∏è  Estat√≠sticas n√£o dispon√≠veis na vers√£o actual")
            else:
                print(f"‚ùå Erro ao obter estat√≠sticas: {stats.get('error')}")
        return
    
    if args.check_feature:
        if not client.is_authenticated():
            print("‚ùå √â necess√°rio fazer login primeiro")
            return
        
        result = client.check_feature_access(args.check_feature)
        if result.get('success', True):
            feature = result.get('featureName', args.check_feature)
            has_access = result.get('hasAccess', False)
            required_tier = result.get('requiredTier', 'unknown')
            
            status = "‚úÖ Dispon√≠vel" if has_access else f"‚ùå Requer tier {required_tier.upper()}"
            print(f"Funcionalidade '{feature}': {status}")
        else:
            if "n√£o encontrado" in result.get('error', '').lower():
                print("‚ÑπÔ∏è  Verifica√ß√£o de funcionalidades n√£o dispon√≠vel na vers√£o actual")
            else:
                print(f"‚ùå Erro: {result.get('error')}")
        return
    
    # Processar pergunta
    if args.query:
        
        if not client.is_authenticated():
            print("‚ùå N√£o autenticado. Execute 'manai login' primeiro.")
            return
        
        # Verificar limites se sistema freemium dispon√≠vel
        limits = client.check_usage_limits(args.language)
        if limits.get('success') and not limits.get('canMakeQuery', True):
            print("‚ùå Limite de consultas di√°rias atingido!")
            print(f"üìä Utiliza√ß√£o: {limits.get('currentUsage', 0)}/{limits.get('dailyLimit', 0)}")
            print("üí° Considere fazer upgrade para ManAI Pro para consultas ilimitadas")
            return
        
        print(f"ü§ñ Pergunta: {args.query}")
        print("‚è≥ A processar com IA no Azure...")
        
        # Fazer a pergunta
        result = client.ask_question(args.query, args.language, use_session=not args.new_session)
        
        # Mostrar resultado
        if result.get('success'):
            # Obter resposta (compat√≠vel com ambos os formatos)
            answer = result.get('answer') or result.get('Answer', 'Sem resposta')
            
            print("\n‚úÖ Resposta do ManAI:")
            print("-" * 50)
            print(answer)
            
            # Mostrar informa√ß√£o da utiliza√ß√£o se dispon√≠vel
            usage_info = result.get('usageInfo', {})
            if usage_info and usage_info.get('queriesUsedToday') != 'N/A':
                used = usage_info.get('queriesUsedToday', 0)
                limit = usage_info.get('dailyLimit', 0)
                if limit > 0:
                    print(f"\nüìä Utiliza√ß√£o: {used}/{limit}")
                    if used >= limit * 0.8:  # Aviso quando atingir 80%
                        print("‚ö†Ô∏è  Est√° pr√≥ximo do limite di√°rio. Considere upgrade para ManAI Pro")
                else:
                    print(f"\nüìä Consultas hoje: {used} (ilimitadas)")
            
            # Mostrar informa√ß√£o da sess√£o
            thread_id = result.get('ThreadId') or result.get('ThreadId')
            if thread_id and not args.new_session:
                thread_short = thread_id[-8:] if len(thread_id) > 8 else thread_id
                print(f"üí¨ Sess√£o: {thread_short}... (use --new-session para reiniciar)")
        else:
            print(f"\n‚ùå Erro: {result.get('error', 'Erro desconhecido')}")
            
            # Sugest√µes baseadas no tipo de erro
            error_msg = result.get('error', '').lower()
            if "token" in error_msg or "autentica√ß√£o" in error_msg:
                print("\nüîß Solu√ß√£o: Execute 'manai --login' para autenticar")
            elif "limite" in error_msg:
                print("\nüîß Solu√ß√£o: Aguarde at√© amanh√£ ou fa√ßa upgrade para ManAI Pro")
            elif "conex√£o" in error_msg or "timeout" in error_msg:
                print("\nüîß Sugest√µes:")
                print("- Verifique a sua liga√ß√£o √† internet")
                print("- Confirme se as Azure Functions est√£o dispon√≠veis")
                print(f"- Teste a conex√£o: manai --test-connection")
            elif "chave" in error_msg or "403" in error_msg:
                print("\nüîß Solu√ß√£o: Verifique a chave de acesso √†s Azure Functions")
            
            sys.exit(1)

if __name__ == "__main__":
    main()
